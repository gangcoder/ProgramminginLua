<html>

<head>
  <title>13.1 算术运算的Metamethods - Lua程序设计</title>
  <meta http-equiv=Content-Type content="text/html; charset=UTF-8">
  <meta name="GENERATOR" content="Macrobject Word-2-CHM">
  <link rel="stylesheet" href="Word2Chm.css" type="text/css">
  <link rel="stylesheet" href="default.css" type="text/css" />
</head>

<body lang=ZH-CN link=blue vlink=purple style='text-justify-trim:punctuation'>
  <table width="100%" cellpadding="0" cellspacing="0" border="0">
    <tr>
      <td class="moHeader">&nbsp;13.1 算术运算的Metamethods</td>
    </tr>
  </table>
  
  <p></p>

<div class=Section1 style='layout-grid:15.6pt'>



<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>这一部分我们通过一个简单的例子介绍如何使用</span><span
lang=EN-US>metamethods</span><span style='font-family:宋体'>。假定我们使用</span><span
lang=EN-US>table</span><span style='font-family:宋体'>来描述结合，使用函数来描述集合的并操作，交集操作，</span><span
lang=EN-US>like</span><span style='font-family:宋体'>操作。我们在一个表内定义这些函数，然后使用构造函数创建一个集合：</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:#fff;margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(248,226,246)'><span
lang=EN-US>Set = {}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(235,230,250)'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.new (t)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>local</span> set = {}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(220,227,241)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>for</span> _, l <span
style='color:blue'>in</span> ipairs(t) <span style='color:blue'>do</span>
set[l] = <span style='color:blue'>true</span> <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>return</span> set</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(225,246,251)'><span
lang=EN-US style='color:blue'>end</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(252,253,253)'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.union (a,b)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>local</span> res =
Set.new{}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(255,253,240)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>for</span> k <span
style='color:blue'>in</span> pairs(a) <span style='color:blue'>do</span> res[k]
= <span style='color:blue'>true</span> <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>for</span> k <span
style='color:blue'>in</span> pairs(b) <span style='color:blue'>do</span> res[k]
= <span style='color:blue'>true</span> <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(220,245,253)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>return</span> res</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>end</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(251,254,240)'><span
lang=EN-US>&nbsp;</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.intersection
(a,b)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(241,226,229)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>local</span> res =
Set.new{}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>for</span> k <span
style='color:blue'>in</span> pairs(a) <span style='color:blue'>do</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(244,225,233)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res[k] = b[k]</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(251,243,230)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>return</span> res</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>end</span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>为了帮助理解程序运行结果，我们也定义了打印函数输出结果：</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(248,229,240);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.tostring
(set)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(230,228,234)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>local</span> s = <span
style='color:red'>&quot;{&quot;</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>local</span> sep = <span
style='color:red'>&quot;&quot;</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(220,249,222)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>for</span> e <span
style='color:blue'>in</span> pairs(set) <span style='color:blue'>do</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s = s .. sep .. e</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(247,223,224)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sep = <span style='color:red'>&quot;,
&quot;</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(226,230,234)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>return</span> s .. <span
style='color:red'>&quot;}&quot;</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>end</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(252,250,237)'><span
lang=EN-US>&nbsp;</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.print (s)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(221,233,253)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; print(Set.tostring(s))</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>end</span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>现在我们想加号运算符</span><span
lang=EN-US>(+)</span><span style='font-family:宋体'>执行两个集合的并操作，我们将所有集合共享一个</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>，并且为这个</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>添加如何处理相加操作。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>第一步，我们定义一个普通的表，用来作为</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>。为避免污染命名空间，我们将其放在</span><span
lang=EN-US>set</span><span style='font-family:宋体'>内部。</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(230,240,229);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>Set.mt = {}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span
style='color:green'>-- metatable for sets</span></span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>第二步，修改</span><span
lang=EN-US>set.new</span><span style='font-family:宋体'>函数，增加一行，创建表的时候同时指定对应的</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>。</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(249,227,224);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.new (t)&nbsp;&nbsp;&nbsp;&nbsp; <span
style='color:green'>-- 2nd version</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(248,230,226)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>local</span> set = {}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; setmetatable(set, Set.mt)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(229,245,246)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>for</span> _, l <span
style='color:blue'>in</span> ipairs(t) <span style='color:blue'>do</span>
set[l] = <span style='color:blue'>true</span> <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>return</span> set</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(244,223,225)'><span
lang=EN-US style='color:blue'>end</span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>这样一来，</span><span
lang=EN-US>set.new</span><span style='font-family:宋体'>创建的所有的集合都有相同的</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>了：</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:#fff;margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(255,244,228)'><span
lang=EN-US>s1 = Set.new{10, 20, 30, 50}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>s2 = Set.new{30, 1}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(253,234,242)'><span
lang=EN-US>print(getmetatable(s1))&nbsp;&nbsp;&nbsp;&nbsp; <span
style='color:green'>--&gt; table: 00672B60</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>print(getmetatable(s2))&nbsp;&nbsp;&nbsp;&nbsp; <span
style='color:green'>--&gt; table: 00672B60</span></span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>第三步，给</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>增加</span><span
lang=EN-US>__add</span><span style='font-family:宋体'>函数。</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(246,227,248);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>Set.mt.__add = Set.union</span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>当</span><span
lang=EN-US>Lua</span><span style='font-family:宋体'>试图对两个集合相加时，将调用这个函数，以两个相加的表作为参数。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>通过</span><span
lang=EN-US>metamethod</span><span style='font-family:宋体'>，我们可以对两个集合进行相加：</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(239,227,245);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>s3 = s1 + s2</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(238,250,247)'><span
lang=EN-US>Set.print(s3)&nbsp;&nbsp;&nbsp;&nbsp; <span style='color:green'>--&gt;
{1, 10, 20, 30, 50}</span></span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>同样的我们可以使用相乘运算符来定义集合的交集操作</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:#fff;margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(244,234,238)'><span
lang=EN-US>Set.mt.__mul = Set.intersection</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(254,249,249)'><span
lang=EN-US>Set.print((s1 + s2)*s1)&nbsp;&nbsp;&nbsp;&nbsp; <span
style='color:green'>--&gt; {10, 20, 30, 50}</span></span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>对于每一个算术运算符，</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>都有对应的域名与其对应，除了</span><span
lang=EN-US>__add</span><span style='font-family:宋体'>、</span><span lang=EN-US>__mul</span><span
style='font-family:宋体'>外，还有</span><span lang=EN-US>__sub(</span><span
style='font-family:宋体'>减</span><span lang=EN-US>)</span><span style='font-family:
宋体'>、</span><span lang=EN-US>__div(</span><span style='font-family:宋体'>除</span><span
lang=EN-US>)</span><span style='font-family:宋体'>、</span><span lang=EN-US>__unm(</span><span
style='font-family:宋体'>负</span><span lang=EN-US>)</span><span style='font-family:
宋体'>、</span><span lang=EN-US>__pow(</span><span style='font-family:宋体'>幂</span><span
lang=EN-US>)</span><span style='font-family:宋体'>，我们也可以定义</span><span
lang=EN-US>__concat</span><span style='font-family:宋体'>定义连接行为。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>当我们对两个表进行加没有问题，但如果两个操作数有不同的</span><span
lang=EN-US>metatable</span><span style='font-family:宋体'>例如：</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:#fff;margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(221,253,231)'><span
lang=EN-US>s = Set.new{1,2,3}</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>s = s + 8</span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>Lua</span><span
style='font-family:宋体'>选择</span><span lang=EN-US>metamethod</span><span
style='font-family:宋体'>的原则：如果第一个参数存在带有</span><span lang=EN-US>__add</span><span
style='font-family:宋体'>域的</span><span lang=EN-US>metatable</span><span
style='font-family:宋体'>，</span><span lang=EN-US>Lua</span><span
style='font-family:宋体'>使用它作为</span><span lang=EN-US>metamethod</span><span
style='font-family:宋体'>，和第二个参数无关；</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>否则第二个参数存在带有</span><span
lang=EN-US>__add</span><span style='font-family:宋体'>域的</span><span lang=EN-US>metatable</span><span
style='font-family:宋体'>，</span><span lang=EN-US>Lua</span><span
style='font-family:宋体'>使用它作为</span><span lang=EN-US>metamethod </span><span
style='font-family:宋体'>否则报错。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>Lua</span><span
style='font-family:宋体'>不关心这种混合类型的，如果我们运行上面的</span><span lang=EN-US>s=s+8</span><span
style='font-family:宋体'>的例子在</span><span lang=EN-US>Set.union</span><span
style='font-family:宋体'>发生错误：</span></p>

<div style='border:dashed windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(241,232,228);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltP style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>bad argument #1 to `pairs' (table expected, got number)</span></p>

</div>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>如果我们想得到更加清楚地错误信息，我们需要自己显式的检查操作数的类型：</span></p>

<div style='border:RGB(212,114,110) dashed 1px;padding:1.0pt 4.0pt 1.0pt 4.0pt;
background:RGB(254,223,254);margin-left:21.0pt;margin-right:21.0pt'>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>function</span><span lang=EN-US> Set.union (a,b)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(220,252,225)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>if</span>
getmetatable(a) ~= Set.mt <span style='color:blue'>or</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US style='color:blue'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US>getmetatable(b) ~= Set.mt <span style='color:blue'>then</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(249,248,252)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; error(<span style='color:red'>&quot;attempt
to `add' a set with a non-set value&quot;</span>, 2)</span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:#fff'><span
lang=EN-US>&nbsp;&nbsp;&nbsp; <span style='color:blue'>end</span></span></p>

<p class=AltD style='margin:0cm;margin-bottom:.0001pt;background:RGB(223,234,246)'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...&nbsp; <span
style='color:green'>-- same as before</span></span></p>

</div>


</div>
  <p></p>
  <hr class="moHR" />
  <span class="moCopyright">
    相关链接：
<br /><a href=3.htm>lua程序设计目录</a> - <a href="http://www.luaer.cn">中国lua开发者</a> - <a href="http://bbs.luaer.cn">lua论坛</a> 
  </span><div id="bookfoot"></div>
<script language="JavaScript" src="js/ad.js"></script>
</body>

</html>

